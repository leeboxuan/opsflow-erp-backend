generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id                         String                       @id @default(cuid())
  name                       String
  slug                       String                       @unique
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  driver_wallet_entries      driver_wallet_entries[]
  driverWalletTransactions   DriverWalletTransaction[]
  drivers                    drivers[]
  driverLocationLatest       DriverLocationLatest[]
  eventLogs                  EventLog[]
  inventory_items            inventory_items[]
  inventory_batches          inventory_batches[]
  inventory_batch_items      inventory_batch_items[]
  inventory_units            inventory_units[]
  podPhotoDocuments          PodPhotoDocument[]
  pods                       Pod[]
  stops                      Stop[]
  memberships                TenantMembership[]
  transportOrders            TransportOrder[]
  transport_order_items      transport_order_items[]
  trips                      Trip[]
  vehicles                   Vehicle[]
  transport_order_item_units transport_order_item_units[]

  @@map("tenants")
}

model User {
  id          String             @id @default(cuid())
  /// Supabase Auth user id (auth.users.id, UUID). Links JWT sub to this row; not the same as id (cuid).
  authUserId  String?            @unique
  email       String             @unique
  name        String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  /// Application-level role for this user (e.g. 'USER', 'SUPERADMIN')
  role        UserRole           @default(USER)
  drivers     drivers[]
  profiles    profiles?
  memberships TenantMembership[]

  @@index([email])
  @@index([authUserId])
  @@map("users")
}

model TenantMembership {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String
  role      Role
  status    MembershipStatus @default(Active)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId, status])
  @@index([userId])
  @@map("tenant_memberships")
}

model TransportOrder {
  id                  String      @id @default(cuid())
  tenantId            String
  customerRef         String
  status              OrderStatus @default(Draft)
  pickupWindowStart   DateTime?
  pickupWindowEnd     DateTime?
  deliveryWindowStart DateTime?
  deliveryWindowEnd   DateTime?

  // ✅ already exists
  notes String?

  // ✅ NEW
  customerContactNumber String?

  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime                  @updatedAt
  priceCents                 Int?
  currency                   String?                   @default("SGD")
  customerName               String?
  doDocumentUrl              String?
  doSignatureUrl             String?
  doSignedAt                 DateTime?
  doSignerName               String?
  doStatus                   DoStatus                  @default(PENDING)
  doVersion                  Int                       @default(1)
  itemsJson                  Json?
  orderRef                   String
  driver_wallet_transactions DriverWalletTransaction[]
  stops                      Stop[]                    @relation("OrderStops")
  transport_order_items      transport_order_items[]
  inventory_units            inventory_units[]
  tenant                     Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, orderRef])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("transport_orders")
}

model Trip {
  id                   String                    @id @default(cuid())
  tenantId             String
  status               TripStatus                @default(Draft)
  plannedStartAt       DateTime?
  plannedEndAt         DateTime?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  closedAt             DateTime?
  startedAt            DateTime?
  acceptedTrailerNo    String?
  acceptedVehicleNo    String?
  assignedDriverUserId String?
  driverId             String?
  routeVersion         Int                       @default(1)
  vehicleId            String?
  walletTransactions   DriverWalletTransaction[]
  stops                Stop[]
  inventory_units      inventory_units[]
  drivers              drivers?                  @relation(fields: [driverId], references: [id])
  tenant               Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicles             Vehicle?                  @relation(fields: [vehicleId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, plannedStartAt])
  @@index([tenantId, assignedDriverUserId])
  @@index([tenantId, driverId])
  @@index([tenantId, vehicleId])
  @@map("trips")
}

model Vehicle {
  id            String   @id @default(cuid())
  tenantId      String
  vehicleNumber String
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  trips         Trip[]
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, vehicleNumber])
  @@index([tenantId])
  @@map("vehicles")
}

model Stop {
  id                         String                    @id @default(cuid())
  tenantId                   String
  tripId                     String?
  sequence                   Int?
  type                       StopType
  addressLine1               String
  addressLine2               String?
  city                       String
  postalCode                 String
  country                    String
  plannedAt                  DateTime?
  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime                  @updatedAt
  transportOrderId           String?
  completedAt                DateTime?
  startedAt                  DateTime?
  status                     StopStatus                @default(Pending)
  driver_wallet_transactions DriverWalletTransaction[]
  podPhotoDocuments          PodPhotoDocument[]
  pods                       Pod[]
  inventory_units            inventory_units[]
  tenant                     Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transportOrder             TransportOrder?           @relation("OrderStops", fields: [transportOrderId], references: [id])
  trip                       Trip?                     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tenantId, transportOrderId])
  @@index([tenantId, tripId])
  @@map("stops")
}

model Pod {
  id        String    @id @default(cuid())
  tenantId  String
  stopId    String
  status    PodStatus @default(Pending)
  signedBy  String?
  signedAt  DateTime?
  photoUrl  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  photoKeys Json?
  stop      Stop      @relation(fields: [stopId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, stopId])
  @@index([tenantId, status])
  @@map("pods")
}

model PodPhotoDocument {
  id        String   @id @default(cuid())
  tenantId  String
  stopId    String
  photoKey  String
  createdAt DateTime @default(now())
  stop      Stop     @relation(fields: [stopId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, stopId])
  @@map("pod_photo_documents")
}

model DriverWalletTransaction {
  id               String          @id @default(cuid())
  tenantId         String
  tripId           String?
  amountCents      Int
  currency         String          @default("SGD")
  type             String
  description      String?
  createdAt        DateTime        @default(now())
  driverId         String
  stopId           String?
  transportOrderId String?
  drivers          drivers         @relation(fields: [driverId], references: [id], onDelete: Cascade)
  stops            Stop?           @relation(fields: [stopId], references: [id])
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transport_orders TransportOrder? @relation(fields: [transportOrderId], references: [id])
  trip             Trip?           @relation(fields: [tripId], references: [id])

  @@unique([tripId, transportOrderId])
  @@index([stopId])
  @@index([tenantId, driverId])
  @@map("driver_wallet_transactions")
}

model EventLog {
  id         String   @id @default(cuid())
  tenantId   String
  entityType String
  entityId   String
  eventType  String
  payload    Json?
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
  @@map("event_logs")
}

model DriverLocationLatest {
  id           String   @id @default(cuid())
  tenantId     String
  driverUserId String
  lat          Float
  lng          Float
  accuracy     Float?
  heading      Float?
  speed        Float?
  capturedAt   DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, driverUserId])
  @@index([tenantId, updatedAt])
  @@map("driver_location_latest")
}

model driver_wallet_entries {
  id          String   @id
  tenantId    String
  driverId    String
  amountCents Int
  currency    String   @default("SGD")
  sourceType  String
  sourceId    String
  createdAt   DateTime @default(now())
  drivers     drivers  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  tenants     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([driverId, createdAt])
  @@index([tenantId, driverId])
}

model drivers {
  id                         String                    @id
  tenantId                   String
  email                      String
  name                       String
  phone                      String
  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime
  userId                     String?
  driver_wallet_entries      driver_wallet_entries[]
  driver_wallet_transactions DriverWalletTransaction[]
  tenants                    Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users                      User?                     @relation(fields: [userId], references: [id])
  trips                      Trip[]

  @@unique([tenantId, email])
  @@unique([tenantId, userId])
  @@index([tenantId])
}

model inventory_items {
  id                    String                  @id
  tenantId              String
  sku                   String
  name                  String
  reference             String?
  availableQty          Int                     @default(0)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  tenants               Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventory_units       inventory_units[]
  inventory_batch_items inventory_batch_items[]
  transport_order_items transport_order_items[]

  @@unique([tenantId, sku])
  @@index([tenantId])
}

model profiles {
  id         String   @id
  userId     String   @unique
  globalRole String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  users      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum Role {
  Admin
  Ops
  Finance
  Driver
}

enum MembershipStatus {
  Active
  Invited
  Suspended
}

enum OrderStatus {
  Draft
  Confirmed
  Planned
  Dispatched
  InTransit
  Delivered
  Closed
  Cancelled
}

enum TripStatus {
  Draft
  Planned
  Dispatched
  InTransit
  Delivered
  Closed
  Cancelled
}

enum StopType {
  PICKUP
  DELIVERY
}

enum PodStatus {
  Pending
  Completed
  Failed
}

enum StopStatus {
  Pending
  InProgress
  Completed
}

enum DoStatus {
  PENDING
  SIGNED
}

enum UserRole {
  SUPERADMIN
  USER
}

enum InventoryBatchStatus {
  Draft
  Open
  Completed
  Cancelled
}

enum InventoryUnitStatus {
  Available
  Reserved
  InTransit
  Delivered
  Returned
  Damaged
  Cancelled
}

model inventory_batches {
  id                    String                  @id @default(cuid())
  tenantId              String
  batchCode             String
  customerName          String?
  customerRef           String?
  receivedAt            DateTime?
  notes                 String?
  status                InventoryBatchStatus    @default(Draft)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  tenant                Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventory_batch_items inventory_batch_items[]
  inventory_units       inventory_units[]
  transport_order_items transport_order_items[]

  @@unique([tenantId, batchCode])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("inventory_batches")
}

model inventory_batch_items {
  id              String            @id @default(cuid())
  tenantId        String
  batchId         String
  inventoryItemId String
  qty             Int
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  batch           inventory_batches @relation(fields: [batchId], references: [id], onDelete: Cascade)
  inventory_item  inventory_items   @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@unique([batchId, inventoryItemId])
  @@index([tenantId, batchId])
  @@map("inventory_batch_items")
}

model inventory_units {
  id               String                       @id @default(cuid())
  tenantId         String
  inventoryItemId  String
  batchId          String
  unitSku          String
  status           InventoryUnitStatus          @default(Available)
  transportOrderId String?
  tripId           String?
  stopId           String?
  createdAt        DateTime                     @default(now())
  updatedAt        DateTime                     @updatedAt
  tenant           Tenant                       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventory_item   inventory_items              @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  batch            inventory_batches            @relation(fields: [batchId], references: [id], onDelete: Cascade)
  transport_order  TransportOrder?              @relation(fields: [transportOrderId], references: [id], onDelete: SetNull)
  trip             Trip?                        @relation(fields: [tripId], references: [id], onDelete: SetNull)
  stop             Stop?                        @relation(fields: [stopId], references: [id], onDelete: SetNull)
  order_item_links transport_order_item_units[]

  @@unique([tenantId, unitSku])
  @@index([tenantId, inventoryItemId, status])
  @@index([tenantId, batchId])
  @@index([tenantId, transportOrderId])
  @@index([tenantId, status])
  @@map("inventory_units")
}

model transport_order_items {
  id               String                       @id @default(cuid())
  tenantId         String
  transportOrderId String
  inventoryItemId  String
  batchId          String?
  qty              Int
  createdAt        DateTime                     @default(now())
  updatedAt        DateTime                     @updatedAt
  tenant           Tenant                       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transport_order  TransportOrder               @relation(fields: [transportOrderId], references: [id], onDelete: Cascade)
  inventory_item   inventory_items              @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  batch            inventory_batches?           @relation(fields: [batchId], references: [id], onDelete: SetNull)
  units            transport_order_item_units[]

  @@unique([transportOrderId, inventoryItemId])
  @@index([tenantId, transportOrderId])
  @@index([tenantId, inventoryItemId])
  @@index([tenantId, batchId])
  @@map("transport_order_items")
}

model transport_order_item_units {
  id                   String   @id @default(cuid())
  tenantId             String
  transportOrderItemId String
  inventoryUnitId      String
  createdAt            DateTime @default(now())

  tenant         Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order_item     transport_order_items @relation(fields: [transportOrderItemId], references: [id], onDelete: Cascade)
  inventory_unit inventory_units       @relation(fields: [inventoryUnitId], references: [id], onDelete: Cascade)

  @@unique([transportOrderItemId, inventoryUnitId])
  @@index([tenantId, transportOrderItemId])
  @@index([tenantId, inventoryUnitId])
  @@map("transport_order_item_units")
}
